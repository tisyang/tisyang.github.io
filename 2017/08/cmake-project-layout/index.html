<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> CMake 项目模块化布局 · 碎片</title><meta name="description" content="CMake 项目模块化布局 - tisyang"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="short icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" type="text/css"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/tisyang" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><section class="container"><div class="post"><article class="post-block"><h1 class="post-title">CMake 项目模块化布局</h1><div class="post-info">2017年8月6日</div><div class="post-content"><p>在 C\C++ 项目中，通常会有不止一个可执行程序，或者需要将一些调用封装成动态或静态库，来实现项目的模块化，本文就讲解一种支持这种项目布局的方法。</p>
<p>CMake 支持子目录构建（<code>add_subdirectory</code> 指令），本文介绍的布局方法就是基于这个功能来实现。</p>
<a id="more"></a>
<h2 id="项目"><a href="#项目" class="headerlink" title="项目"></a>项目</h2><p>项目根目录编写一个 <code>CMakeLists.txt</code>，主要描述项目名称，也可以将一些项目级别的配置写入，来影响所有项目构建目标。比如编译的警告级别设置，如果要在项目级别上统一，可以写入，如果要针对不同构建目标来设置，可以留到构建目标 <code>CMakeLists.txt</code> 文件中写入。</p>
<p>项目的各个构建目标作为子目录存放在项目根目录下，每个子目录均包含相应的构建 <code>CMakeLists.txt</code> 文件。使用 <code>add_subdirectory</code> 指令将构建目标子目录添加到项目 <code>CMakeLists.txt</code> 中，构建目标间可以相互引用，只要在添加子目录到项目 <code>CMakeLists.txt</code> 时保持依赖顺序即可。</p>
<p>项目 <code>CMakeLists.txt</code> 示例：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">2.6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目名称</span></span><br><span class="line"><span class="keyword">set</span>(PROJECT_NAME <span class="string">"TestApps"</span>)</span><br><span class="line"><span class="keyword">project</span>(<span class="variable">$&#123;PROJECT_NAME&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 统一构建目标输出目录</span></span><br><span class="line"><span class="comment"># 将所有构建目标输出目录定位在构建目录下，按类型分类子目录</span></span><br><span class="line"><span class="comment">#     静态库输出目录 =&gt; 构建目录/lib</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_ARCHIVE_OUTPUT_DIRECTORY <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/lib)</span><br><span class="line"><span class="comment">#     动态库输出目录 =&gt; 构建目录/bin</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_LIBRARY_OUTPUT_DIRECTORY <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/bin)</span><br><span class="line"><span class="comment">#     可执行程序输出目录 =&gt; 构建目录/bin</span></span><br><span class="line"><span class="keyword">set</span>(CMAKE_RUNTIME_OUTPUT_DIRECTORY <span class="variable">$&#123;PROJECT_BINARY_DIR&#125;</span>/bin)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------- 库 ----------</span></span><br><span class="line"><span class="comment"># staticlib 库</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(staticlib)</span><br><span class="line"><span class="comment"># 添加头文件搜索路径，这样其他构建目标可以引用其头文件</span></span><br><span class="line"><span class="keyword">include_directories</span>(staticlib)</span><br><span class="line"></span><br><span class="line"><span class="comment"># sharelib 库</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(sharelib)</span><br><span class="line"><span class="comment"># 添加头文件搜索路径，这样其他构建目标可以引用其头文件</span></span><br><span class="line"><span class="keyword">include_directories</span>(sharelib)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ---------- 应用程序 ----------</span></span><br><span class="line"><span class="comment"># testapp 程序</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(testapp)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置文件类</span></span><br><span class="line"><span class="keyword">add_subdirectory</span>(config)</span><br></pre></td></tr></table></figure>
<p>项目 <code>TestApps</code> 中包含4个构建目标目录，2 个库 <code>staticlib</code> 和 <code>sharelib</code>，依赖库的 1 个应用程序 <code>testapp</code>，以及配置文件类目标 <code>config</code>。4 个目标的输出文件均统一到了构建目录下，按类型分类，这样便于构建结果的归档处理。</p>
<p>通常将构建目标子目录名与目标名一致，这样便于项目管理。</p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>每个构建目标对应在项目根目录下的各个子目录，每个子目录中都有一个 <code>CMakeLists.txt</code> 文件，记录着对应的构建配置。这些构建配置均会继承项目 <code>CMakeLists.txt</code> 文件中的配置。</p>
<p>以下针对示例项目，讲解各个子目录的 <code>CMakeLists.txt</code> ，用以理解如何进行具体的项目布局。</p>
<h3 id="目标-staticlib（静态库编译示例）："><a href="#目标-staticlib（静态库编译示例）：" class="headerlink" title="目标 staticlib（静态库编译示例）："></a>目标 <code>staticlib</code>（静态库编译示例）：</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译选项</span></span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="string">"-std=gnu99"</span>)</span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="string">"-Wall"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(SLIB <span class="string">"staticlib"</span>)</span><br><span class="line"><span class="keyword">aux_source_directory</span>(<span class="string">"."</span> SLIB_SRC)</span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;SLIB&#125;</span> STATIC <span class="variable">$&#123;SLIB_SRC&#125;</span>)</span><br><span class="line"><span class="comment"># 依赖库</span></span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;SLIB&#125;</span> m)</span><br></pre></td></tr></table></figure>
<p><code>add_library</code> 指令添加一个库目标，参数 <code>STATIC</code> 表示编译成静态库，该目标链接时需要链接数学库。</p>
<h3 id="目标-sharelib（动态库编译示例）："><a href="#目标-sharelib（动态库编译示例）：" class="headerlink" title="目标 sharelib（动态库编译示例）："></a>目标 <code>sharelib</code>（动态库编译示例）：</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_definitions</span>(<span class="string">"-std=gnu99"</span>)</span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="string">"-Wall"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(DLIB <span class="string">"sharelib"</span>)</span><br><span class="line"><span class="keyword">aux_source_directory</span>(<span class="string">"."</span> DLIB_SRC)</span><br><span class="line"><span class="keyword">add_library</span>(<span class="variable">$&#123;DLIB&#125;</span> SHARED <span class="variable">$&#123;DLIB_SRC&#125;</span>)</span><br></pre></td></tr></table></figure>
<p>与目标 <code>staticlib</code> 差不多，只是<code>add_library</code> 参数 <code>SHARED</code> 表示编译成动态库。</p>
<h3 id="目标-testapp（执行程序编译示例）："><a href="#目标-testapp（执行程序编译示例）：" class="headerlink" title="目标 testapp（执行程序编译示例）："></a>目标 <code>testapp</code>（执行程序编译示例）：</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 编译选项</span></span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="string">"-std=gnu99"</span>)</span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="string">"-Wall"</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span>(APP <span class="string">"testapp"</span>)</span><br><span class="line"><span class="keyword">aux_source_directory</span>(<span class="string">"."</span> APP_SRC)</span><br><span class="line"><span class="keyword">add_executable</span>(<span class="variable">$&#123;APP&#125;</span> <span class="variable">$&#123;APP_SRC&#125;</span>)</span><br><span class="line"><span class="keyword">target_link_libraries</span>(<span class="variable">$&#123;APP&#125;</span></span><br><span class="line">        staticlib</span><br><span class="line">        sharelib)</span><br></pre></td></tr></table></figure>
<p><code>add_executable</code> 指令添加一个可执行目标，其依赖于静态库 <code>staticlib</code> 和动态库 <code>sharelib</code>。</p>
<h3 id="目标-config（配置文件示例）："><a href="#目标-config（配置文件示例）：" class="headerlink" title="目标 config（配置文件示例）："></a>目标 <code>config</code>（配置文件示例）：</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 拷贝文件到输出目录，便于后续打包安装文件</span></span><br><span class="line">file(COPY .</span><br><span class="line">    DESTINATION <span class="variable">$&#123;CMAKE_RUNTIME_OUTPUT_DIRECTORY&#125;</span></span><br><span class="line">    <span class="comment"># 忽略文件匹配模式</span></span><br><span class="line">    PATTERN <span class="string">"CMakeLists.txt"</span> EXCLUDE</span><br><span class="line">    PATTERN <span class="string">"README.md"</span> EXCLUDE</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<p><code>config</code> 目标是一个特殊目标，其不构建库或可执行程序，而是执行一个文件拷贝工作，在此示例中，将 <code>config</code> 目录下的文件（除 <code>CMakeLists.txt</code> 和 <code>README.md</code>）都拷贝到可执行输出目录中。这个用法一般用于拷贝程序的默认配置文件。这样做的好处在于可以将默认配置文件纳入版本管理，也方便打包程序以及测试部署，既能将代码与输出分离，又能实现自动化整合。</p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>CMake 是一个很便利的跨平台构建工具，使用模块化布局方法可以更契合多人共享开发模式，促进项目复用代码，方便上下游库协同管理。如果与 Git 的 submodule 配合，就更能体现出模块化。</p>
</div></article></div></section><footer><div class="paginator"><a href="/2017/09/notes-about-using-apt-package-cross-gcc-arm/" class="prev">PREV</a><a href="/2017/01/split-string-in-shell/" class="next">NEXT</a></div><div class="copyright"><p>© 2016 - 2017 <a href="https://tisyang.github.io">tisyang</a>, unless otherwise noted.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.6.1/MathJax.js?config=TeX-MML-AM_CHTML"></script></body></html>